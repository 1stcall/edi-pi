---
- name: Set stretch as default release.
  copy: src=08default-release dest={{ default_release_file }}

- name: Add buster repository for packages that are not available on stretch.
  copy: src=buster.list dest={{ buster_list }}

- name: Update apt cache.
  apt: update_cache=yes

- name: Install mender-client.
  apt: name=mender-client state=present install_recommends=no default_release=buster

- name: Remove buster repository.
  file: dest={{ buster_list }} state=absent

- name: Remove stretch default release setting.
  file: dest={{ default_release_file }} state=absent

- name: Update apt cache.
  apt: update_cache=yes

- name: Load project specific (customized) mender configuration.
  include_vars: "{{ item}}"
  with_first_found:
    - "{{ mender_config_directory }}/mender_custom.yml"
    - "{{ mender_config_directory }}/mender.yml"

- name: Write mender main configuration.
  template:
    src: mender.conf
    dest: /etc/mender/

- name: Create mender directory on data partition.
  file:
    path: /data/mender
    state: directory

- name: Configure the device type.
  template:
    src: device_type
    dest: /data/mender/device_type

- name: Copy the server certificate.
  copy:
    src: "{{ mender_config_directory }}/certificates/server.crt"
    dest: /etc/mender/

- name: Copy inventory scripts.
  copy:
    src: "{{ item }}"
    dest: /usr/share/mender/inventory/
    mode: 0755
  with_fileglob:
    - "{{ mender_config_directory }}/inventory/*"

- name: Copy identity scripts.
  copy:
    src: "{{ item }}"
    dest: /usr/share/mender/identity/
    mode: 0755
  with_fileglob:
    - "{{ mender_config_directory }}/identity/*"
