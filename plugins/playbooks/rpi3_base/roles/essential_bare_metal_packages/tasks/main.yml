---
- name: Prevent service startup during installation.
  copy: src=policy-rc.d dest=/usr/sbin/ mode=755

- name: Create temporary firmware directory within boot folder.
  file: path=/boot/firmware_temp state=directory
  
- name: Create /boot/firmware mountpoint to enable installation of firmware package.
  mount: opts=bind fstype=none state=mounted path=/boot/firmware src=/boot/firmware_temp

- name: Install packages that are essential for running on bare metal.
  apt: name={{ item }} state=present install_recommends=no
  with_items: "{{ bare_metal_packages }}"

- name: Install backports packages that are essential for running on bare metal.
  apt: name={{ item }} state=present install_recommends=no default_release=stretch-backports
  with_items: "{{ bare_metal_backports_packages }}"

- name: Remove /boot/firmware mountpoint.
  mount: state=absent path=/boot/firmware

- name: Remove service startup prevention.
  file: dest=/usr/sbin/policy-rc.d state=absent


